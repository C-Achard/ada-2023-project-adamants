

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Milestone P3 : Full notebook &#8212; ADA - Milestone P2 - ADAmants</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'P3_notebook';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="README_p3.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo_cropped.png" class="logo__image only-light" alt="ADA - Milestone P2 - ADAmants - Home"/>
    <script>document.write(`<img src="_static/logo_cropped.png" class="logo__image only-dark" alt="ADA - Milestone P2 - ADAmants - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="README_p3.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="data_loading.html">Data loading and pre-processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="leiden_clustering.html">Leiden clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="leiden_clustering_validation.html">Robustness of the Leiden clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="leiden_clustering_w_timeouts.html">Clustering with the timeouts</a></li>
<li class="toctree-l1"><a class="reference internal" href="hierarchical_and_gmm_clustering.html">Alternative clustering methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="optics_DBSCAN.html">Clustering using DBSCAN and its extension OPTICS</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/epfl-ada/ada-2023-project-adamants" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/P3_notebook.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Milestone P3 : Full notebook</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#description-of-the-features-used">Description of the features used</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-loading-and-pre-processing">Data loading and pre-processing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#correlations-and-pca">Correlations and PCA</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pca">PCA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#correlation-matrix">Correlation matrix</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clustering-without-the-timeouts">Clustering without the timeouts</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-clustering">The clustering</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-heatmap-of-feature-means-for-each-cluster">The Heatmap of feature means for each cluster…</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#and-the-number-of-paths-per-cluster">And the number of paths per cluster</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assessing-variability-using-clustroids">Assessing variability using clustroids</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assessing-the-variability-of-the-clustering-across-folds">Assessing the variability of the clustering across folds</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#matching-to-the-rescue">Matching to the rescue</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-of-clustroids-variation-across-folds">Plot of clustroids variation across folds</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#variability-of-features-across-folds-in-matched-clusters">Variability of features across folds in matched clusters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clustering-with-the-timeouts">Clustering with the timeouts</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#umap-plot-of-the-leiden-clustering">UMAP plot of the Leiden clustering</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#features-distributions-across-clusters">Features distributions across clusters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#heatmap-of-feature-means-for-each-cluster">Heatmap of feature means for each cluster</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#number-of-paths-per-cluster">Number of paths per cluster</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="milestone-p3-full-notebook">
<h1>Milestone P3 : Full notebook<a class="headerlink" href="#milestone-p3-full-notebook" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># dimensionality reduction</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">umap</span> <span class="kn">import</span> <span class="n">umap_</span> <span class="k">as</span> <span class="n">UMAP</span>

<span class="c1"># plotting</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>

<span class="c1"># clustering</span>
<span class="kn">from</span> <span class="nn">leiden_clustering</span> <span class="kn">import</span> <span class="n">LeidenClustering</span>
<span class="kn">import</span> <span class="nn">utils</span>
</pre></div>
</div>
</div>
</div>
<section id="description-of-the-features-used">
<h2>Description of the features used<a class="headerlink" href="#description-of-the-features-used" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>duration in second: Time taken by the player to complete the path (directly provided in the dataset).</p></li>
<li><p>backtrack: Number of backtracks made by the player in this path.</p></li>
<li><p>numberOfPath: Number of paths previously played by the player, in total.</p></li>
<li><p>position_mean: Character position of succeding clicked link on article page, averaged across all edges of path.</p></li>
<li><p>position_std: Standard deviation of character position of succeding clicked link within a path.</p></li>
<li><p>path_length: Simple measure of number of edges in path (pages clicked on) from beginning to end. Does not contains player backtracks, and so counts the final version of player path.</p></li>
<li><p>coarse_mean_time: Measure of amount of time, on average, that the player took to travel from one edge to another in the path. It is called “coarse” because it is a global measure, that does not take into account outlier edges like the median could. This is especially noticeable on paths where the player disconnected, for example.</p></li>
<li><p>semantic_similarity: This is a measure of the average similarity between two successive terms in the given path. The feature is calculated by computing the cosine similarity (normalised dot product) between embeddings (one-hot vectors projected to a lower dimensionality subspace) given by a sentence transformer, which is a model specifically trained in order to give embeddings which have “semantically relevant” / “semantically informative” relative positions. As such, the cosine similarity gives a measure of logical similarity of the words. A value of -1 represents opposite meanings / topics, around 0 means unrelated, and around 1 means highly similar meanings / topics. The mean of this is supposed to approximately capture how related topics globally were on a given path.</p></li>
<li><p>ratio: The ratio between the user path and the shortest path between the start and end page.</p></li>
<li><p>path_closeness_abs_sum : As each page in the path has a closeness centrality associated to it from the full network of Wikipedia, this features is obtained by looking at the derivative of the closeness centrality of each page in the path (that is, the delta between the closeness centrality of a page and the previous one in the path) and summing the absolute value of these deltas before and after the maximal degree page in the path.
This is meant to quantify if the player is strongly looking for a hub page in the path, reaches it (as the maximal degree page is assumed to be a hub page) and then goesto a specific page from there, i.e. the target page. Indeed, a good player is expected to have a strongly positive delta before the maximal degree page and a strongly negative delta after it. We take the absolute value then sum them to have a single feature that aims at quantifying this behavior.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DATA_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;../data&quot;</span>
<span class="n">FIG_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;../src&quot;</span>
<span class="n">FILTER_TIMEOUT</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="n">FILTER_TIMEOUT</span><span class="p">:</span>
    <span class="n">FIG_PATH</span> <span class="o">=</span> <span class="n">FIG_PATH</span> <span class="o">/</span> <span class="s2">&quot;figures/leiden/&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">FIG_PATH</span> <span class="o">=</span> <span class="n">FIG_PATH</span> <span class="o">/</span> <span class="s2">&quot;figures/leiden_with_timeout/&quot;</span>
<span class="n">FIG_PATH</span> <span class="o">=</span> <span class="n">FIG_PATH</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Figure path: </span><span class="si">{</span><span class="n">FIG_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">DATA_PATH</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;combined_*.csv&quot;</span><span class="p">)</span>
<span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">FIG_PATH</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="n">FIG_PATH</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Figure path: D:\ADA\ada-2023-project-adamants\src\figures\leiden_with_timeout
[&#39;combined_metrics_finished_edges&#39;, &#39;combined_metrics_finished_paths&#39;, &#39;combined_metrics_unfinished_edges&#39;, &#39;combined_metrics_unfinished_paths&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_finished_paths</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;combined_metrics_finished_paths&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">features_unfinished_paths</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;combined_metrics_unfinished_paths&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
    <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-loading-and-pre-processing">
<h2>Data loading and pre-processing<a class="headerlink" href="#data-loading-and-pre-processing" title="Permalink to this heading">#</a></h2>
<p>Let’s have a look at features distribution:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">features_finished_paths</span><span class="p">,</span> <span class="n">features_unfinished_paths</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">i_log</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">i_non_log</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">COLS_LOG</span><span class="p">)</span>
<span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">COLS_LOG</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i_log</span>
        <span class="n">i_log</span> <span class="o">=</span> <span class="n">i_log</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i_non_log</span>
        <span class="n">i_non_log</span> <span class="o">=</span> <span class="n">i_non_log</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="n">feature</span><span class="p">],</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/bfb95bbc4af48926251147f6b55ff16bbe7f24ecf78ad16d2adc877c5123f8bf.png" src="_images/bfb95bbc4af48926251147f6b55ff16bbe7f24ecf78ad16d2adc877c5123f8bf.png" />
</div>
</div>
<p>We can see that the features in the first column are very heavy tailed, for this reason we will apply a log transform to them.
Taking the log of backtrack (2nd row first column) does not help (probably as it is discrete and has only a few different values).</p>
<p>We will then normalize the features:</p>
<ul class="simple">
<li><p>We use z-score normalization</p></li>
<li><p>NaN values in certain features are replaced by the mean</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">features_finished_paths</span><span class="p">,</span> <span class="n">features_unfinished_paths</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;finished&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">features_finished_paths</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span>
    <span class="n">features_unfinished_paths</span>
<span class="p">)</span>
<span class="n">combined_df</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">normalize_features</span><span class="p">(</span>
    <span class="n">combined_df</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">i_log</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">i_non_log</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">COLS_LOG</span><span class="p">)</span>
<span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span><span class="p">:</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">COLS_LOG</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i_log</span>
        <span class="n">i_log</span> <span class="o">=</span> <span class="n">i_log</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i_non_log</span>
        <span class="n">i_non_log</span> <span class="o">=</span> <span class="n">i_non_log</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
    <span class="c1"># use log until reaching i_non_log</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="n">feature</span><span class="p">],</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/928cbc6125675b730bab2289423a09eaa7e5e7eb517a69506a93a12df25eb003.png" src="_images/928cbc6125675b730bab2289423a09eaa7e5e7eb517a69506a93a12df25eb003.png" />
</div>
</div>
</section>
<section id="correlations-and-pca">
<h2>Correlations and PCA<a class="headerlink" href="#correlations-and-pca" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">combined_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<section id="pca">
<h3>PCA<a class="headerlink" href="#pca" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># find the dimensionality of the data</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="c1"># plot the explained variance</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;number of components&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;explained variance&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Percentage of explained variance of each component of the PCA&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/80494eca911b76647b958a47e59ea53aabb8b3ba7ee5372c029aa932ee9f015a.png" src="_images/80494eca911b76647b958a47e59ea53aabb8b3ba7ee5372c029aa932ee9f015a.png" />
</div>
</div>
<p>We will keep only the 7 first dimensions as they explain most of the variance compared to further components.</p>
</section>
<section id="correlation-matrix">
<h3>Correlation matrix<a class="headerlink" href="#correlation-matrix" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># feature names for labels</span>
<span class="n">xlabels</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span>
<span class="n">xlabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xlabels</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">camel_to_snake</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Goes from camelCase to snake_case&quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;(.)([A-Z][a-z]+)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1_\2&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;([a-z0-9])([A-Z])&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1_\2&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

<span class="n">xlabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">camel_to_snake</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xlabels</span><span class="p">]</span>
<span class="c1"># remove all underscores</span>
<span class="n">xlabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xlabels</span><span class="p">]</span>
<span class="c1"># cast letter in beginning to uppercase</span>
<span class="n">xlabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xlabels</span><span class="p">]</span>
<span class="n">ylabels</span> <span class="o">=</span> <span class="n">xlabels</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># show correlation between features</span>
<span class="n">corr</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">))</span>
<span class="n">corr</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
    <span class="n">corr</span><span class="p">,</span>
    <span class="n">annot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;icefire&quot;</span><span class="p">,</span>
    <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Correlation between features&quot;</span><span class="p">)</span>
<span class="n">xticks_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xlabels</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xticks_pos</span><span class="p">,</span> <span class="n">xlabels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">xticks_pos</span><span class="p">,</span> <span class="n">ylabels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1"># TODO fix the tick labels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0e44c9b2c36b5a75fc5ffbb197a370b6405dc1df4384ce03d79eba1a5101f800.png" src="_images/0e44c9b2c36b5a75fc5ffbb197a370b6405dc1df4384ce03d79eba1a5101f800.png" />
</div>
</div>
<p>From this plot, we may notice some noteworthy correlations:</p>
<ul class="simple">
<li><p>Time-related features (duration, average_time_on_page, coarse_mean_time) are correlated with each other, which is expected.</p></li>
<li><p>Path length and ratio are correlated with each other, which makes sense as the ratio is the path length divided by the number of pages in the path.</p></li>
</ul>
</section>
</section>
<section id="clustering-without-the-timeouts">
<h2>Clustering without the timeouts<a class="headerlink" href="#clustering-without-the-timeouts" title="Permalink to this heading">#</a></h2>
<p>To give a shorter notebook we skipped some visualizations of the data, but they can be found in the jupyter book</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_finished_paths</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;combined_metrics_finished_paths&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">features_unfinished_paths</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;combined_metrics_unfinished_paths&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
    <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1">#filter out timeouts</span>
<span class="n">features_unfinished_paths</span> <span class="o">=</span> <span class="n">features_unfinished_paths</span><span class="p">[</span>
    <span class="n">features_unfinished_paths</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;timeout&quot;</span>
<span class="p">]</span>

<span class="c1"># add origin for stratified sampling</span>
<span class="n">features_unfinished_paths</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;unfinished&quot;</span>
<span class="n">features_finished_paths</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;finished&quot;</span>

<span class="c1">#combine both dataframes</span>
<span class="n">filtered_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">features_finished_paths</span><span class="p">,</span> <span class="n">features_unfinished_paths</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">filtered_df</span><span class="p">[</span><span class="s2">&quot;finished&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">features_finished_paths</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span>
    <span class="n">features_unfinished_paths</span>
<span class="p">)</span>
<span class="c1">#normalize features</span>
<span class="n">filtered_df</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">normalize_features</span><span class="p">(</span>
    <span class="n">filtered_df</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span><span class="p">]</span>
<span class="p">)</span>
<span class="c1">#drop nan values</span>
<span class="n">filtered_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X_filtered</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

<span class="c1">#### FOR COMPATIBILITY</span>
<span class="n">combined_df</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">plot_data</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="the-clustering">
<h3>The clustering<a class="headerlink" href="#the-clustering" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#fix seed for reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">clustering</span> <span class="o">=</span> <span class="n">LeidenClustering</span><span class="p">(</span>
    <span class="n">leiden_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;n_iterations&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;resolution_parameter&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
    <span class="n">pca_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;n_components&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">},</span>
<span class="p">)</span>
<span class="n">clustering</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_filtered</span><span class="p">)</span>
<span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0, 2, 2, ..., 0, 3, 0])
</pre></div>
</div>
</div>
</div>
</section>
<section id="the-heatmap-of-feature-means-for-each-cluster">
<h3>The Heatmap of feature means for each cluster…<a class="headerlink" href="#the-heatmap-of-feature-means-for-each-cluster" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="c1"># heatmap of features means per cluster</span>
<span class="n">means</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.1f&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Feature&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cluster&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Heatmap of normalized features means per cluster&quot;</span><span class="p">)</span>
<span class="c1"># plt.xticks(labels=xlabels, ticks=range(len(xlabels)), rotation=90) # TODO: fix this</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e991c35e6bf21213c1a8e1b7fd2da3de55a56d63fc2711cd5b0441d1efa8fd36.png" src="_images/e991c35e6bf21213c1a8e1b7fd2da3de55a56d63fc2711cd5b0441d1efa8fd36.png" />
</div>
</div>
</section>
<section id="and-the-number-of-paths-per-cluster">
<h3>And the number of paths per cluster<a class="headerlink" href="#and-the-number-of-paths-per-cluster" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clusters_names</span><span class="p">,</span><span class="n">n_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">clusters_names</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">n_points</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">clusters_names</span><span class="p">))</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Number of paths per cluster&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c28707c8ac95b443c74fbf6f304ffa74bb8c868f060e36b7c0bfd9e1ee159754.png" src="_images/c28707c8ac95b443c74fbf6f304ffa74bb8c868f060e36b7c0bfd9e1ee159754.png" />
</div>
</div>
<p>We can observe that we have one cluster that disappeared, it is the one that had all the timeouts ! Of course the other are a bit modified since the values of the duration are different, but the global trends stay identical.</p>
<p>Or is it ? Are the difference observed statistcally significant ? And can we test the robustness of the clustering ? Is it very sensitive to the data or do the clusters qualitatively stay the same ? It is time to figure it out…</p>
</section>
</section>
<section id="assessing-variability-using-clustroids">
<h2>Assessing variability using clustroids<a class="headerlink" href="#assessing-variability-using-clustroids" title="Permalink to this heading">#</a></h2>
<p>We now have a clustering of our data points; however, to assess robustness of the clustering, we will use medoids, which are clustroids generated from the mean of each cluster.
We will perform cross validation by :</p>
<ul class="simple">
<li><p>Splitting the data into 5 folds</p></li>
<li><p>For each fold, we compute the Leiden clustering from scratch and assign a cluster to each training point.</p></li>
<li><p>We compute the clustroids in the <strong>original UMAP embedding</strong> space (using all data points, not just the ones in the fold). This is to make clusterings comparable across folds : we show the clustering assignments of the training points in a consistent latent space.</p></li>
<li><p>We use k-nearest neighbors to assign each test point to a cluster, again in the original UMAP embedding space.</p></li>
<li><p>We obtain test clustroids by computing the mean of each cluster in the test set.</p></li>
</ul>
<p>For now, we simply show the original clustroids in the entire dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span>
<span class="c1"># find number of NaNs in each column</span>
<span class="n">nans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">nans</span><span class="p">)</span>
<span class="c1"># drop rows with NaNs</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;durationInSec&#39;, &#39;backtrack&#39;, &#39;numberOfPath&#39;, &#39;position_mean&#39;,
       &#39;position_std&#39;, &#39;path_length&#39;, &#39;coarse_mean_time&#39;,
       &#39;semantic_similarity&#39;, &#39;ratio&#39;, &#39;path_closeness_abs_sum&#39;],
      dtype=&#39;object&#39;)
[0 0 0 0 0 0 0 0 0 0]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># UMAP</span>
<span class="n">umap</span> <span class="o">=</span> <span class="n">UMAP</span><span class="o">.</span><span class="n">UMAP</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;euclidean&quot;</span><span class="p">)</span>
<span class="n">result_umap_euc</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_w_clusters</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">combined_df</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span><span class="p">]</span>
        <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;cluster&quot;</span><span class="p">:</span> <span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span><span class="p">}),</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result_umap_euc</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;umap_1&quot;</span><span class="p">,</span> <span class="s2">&quot;umap_2&quot;</span><span class="p">,</span> <span class="s2">&quot;umap_3&quot;</span><span class="p">]),</span>
    <span class="p">],</span>
    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">X_w_clusters</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>durationInSec</th>
      <th>backtrack</th>
      <th>numberOfPath</th>
      <th>position_mean</th>
      <th>position_std</th>
      <th>path_length</th>
      <th>coarse_mean_time</th>
      <th>semantic_similarity</th>
      <th>ratio</th>
      <th>path_closeness_abs_sum</th>
      <th>cluster</th>
      <th>umap_1</th>
      <th>umap_2</th>
      <th>umap_3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.450421</td>
      <td>-0.292447</td>
      <td>-0.397854</td>
      <td>0.012312</td>
      <td>0.948769</td>
      <td>1.246512</td>
      <td>-0.037357</td>
      <td>1.896769</td>
      <td>0.373468</td>
      <td>-4.342440e-01</td>
      <td>0</td>
      <td>-1.107617</td>
      <td>2.549133</td>
      <td>2.624934</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-0.246765</td>
      <td>-0.292447</td>
      <td>0.302599</td>
      <td>-0.645120</td>
      <td>-0.805592</td>
      <td>-0.127465</td>
      <td>-0.104634</td>
      <td>1.187599</td>
      <td>0.373468</td>
      <td>9.426499e-01</td>
      <td>2</td>
      <td>-1.612024</td>
      <td>3.621654</td>
      <td>0.141211</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.247484</td>
      <td>-0.292447</td>
      <td>0.483877</td>
      <td>-0.379822</td>
      <td>-1.074044</td>
      <td>0.971189</td>
      <td>-0.133470</td>
      <td>0.756814</td>
      <td>0.373468</td>
      <td>-4.075266e-01</td>
      <td>2</td>
      <td>-1.906021</td>
      <td>3.432167</td>
      <td>1.573302</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-1.198556</td>
      <td>-0.292447</td>
      <td>-0.591540</td>
      <td>-0.454105</td>
      <td>-0.155640</td>
      <td>-0.649073</td>
      <td>-1.028104</td>
      <td>0.515755</td>
      <td>-0.908596</td>
      <td>-9.236796e-16</td>
      <td>1</td>
      <td>9.620740</td>
      <td>-0.366626</td>
      <td>8.498927</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.508421</td>
      <td>-0.292447</td>
      <td>-0.922649</td>
      <td>0.064624</td>
      <td>1.137702</td>
      <td>0.659053</td>
      <td>0.399219</td>
      <td>-0.870712</td>
      <td>0.373468</td>
      <td>5.543467e-01</td>
      <td>0</td>
      <td>0.845308</td>
      <td>2.123000</td>
      <td>1.607138</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>63112</th>
      <td>0.353632</td>
      <td>-0.292447</td>
      <td>0.508379</td>
      <td>0.277953</td>
      <td>1.172033</td>
      <td>0.659053</td>
      <td>0.196939</td>
      <td>0.499099</td>
      <td>1.655532</td>
      <td>-1.163800e-01</td>
      <td>0</td>
      <td>-0.607751</td>
      <td>6.962692</td>
      <td>11.004099</td>
    </tr>
    <tr>
      <th>63113</th>
      <td>-0.467209</td>
      <td>-0.292447</td>
      <td>0.651736</td>
      <td>-1.439055</td>
      <td>-1.834725</td>
      <td>-1.321543</td>
      <td>0.340616</td>
      <td>-1.735091</td>
      <td>-0.908596</td>
      <td>-9.236796e-16</td>
      <td>1</td>
      <td>9.239454</td>
      <td>0.434836</td>
      <td>6.629303</td>
    </tr>
    <tr>
      <th>63114</th>
      <td>0.551507</td>
      <td>-0.292447</td>
      <td>0.775702</td>
      <td>0.796475</td>
      <td>0.862001</td>
      <td>0.298719</td>
      <td>0.676819</td>
      <td>0.057767</td>
      <td>-0.908596</td>
      <td>1.010689e+00</td>
      <td>0</td>
      <td>7.671624</td>
      <td>-1.034239</td>
      <td>7.682266</td>
    </tr>
    <tr>
      <th>63115</th>
      <td>0.539368</td>
      <td>0.378896</td>
      <td>0.802247</td>
      <td>-0.319231</td>
      <td>-0.426618</td>
      <td>0.298719</td>
      <td>0.247967</td>
      <td>-0.508621</td>
      <td>0.373468</td>
      <td>-1.910789e+00</td>
      <td>3</td>
      <td>-1.946937</td>
      <td>2.796353</td>
      <td>2.952293</td>
    </tr>
    <tr>
      <th>63116</th>
      <td>1.276127</td>
      <td>-0.292447</td>
      <td>0.936431</td>
      <td>0.685458</td>
      <td>1.401843</td>
      <td>-0.127465</td>
      <td>1.885496</td>
      <td>-1.882444</td>
      <td>-0.908596</td>
      <td>4.568906e-01</td>
      <td>0</td>
      <td>7.179870</td>
      <td>-1.093908</td>
      <td>7.084849</td>
    </tr>
  </tbody>
</table>
<p>63117 rows × 14 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># find the clustroid of each cluster</span>
<span class="n">clustroids</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span><span class="p">):</span>
    <span class="n">clustroid</span> <span class="o">=</span> <span class="n">X_w_clusters</span><span class="p">[</span><span class="n">X_w_clusters</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cluster</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">clustroids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clustroid</span><span class="p">)</span>
<span class="n">clustroids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">clustroids</span><span class="p">)</span>
<span class="n">clustroids</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>durationInSec</th>
      <th>backtrack</th>
      <th>numberOfPath</th>
      <th>position_mean</th>
      <th>position_std</th>
      <th>path_length</th>
      <th>coarse_mean_time</th>
      <th>semantic_similarity</th>
      <th>ratio</th>
      <th>path_closeness_abs_sum</th>
      <th>cluster</th>
      <th>umap_1</th>
      <th>umap_2</th>
      <th>umap_3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.425451</td>
      <td>-0.281488</td>
      <td>-0.360041</td>
      <td>0.367251</td>
      <td>0.528534</td>
      <td>0.281371</td>
      <td>0.514292</td>
      <td>-0.068535</td>
      <td>0.388703</td>
      <td>0.144026</td>
      <td>0.0</td>
      <td>1.211408</td>
      <td>2.394772</td>
      <td>4.380532</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-0.827960</td>
      <td>-0.219059</td>
      <td>-0.228548</td>
      <td>-0.255208</td>
      <td>-0.818939</td>
      <td>-1.088791</td>
      <td>-0.347516</td>
      <td>-0.149015</td>
      <td>-1.226315</td>
      <td>0.373028</td>
      <td>1.0</td>
      <td>9.133989</td>
      <td>1.646415</td>
      <td>6.270227</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.499614</td>
      <td>-0.275939</td>
      <td>-0.278799</td>
      <td>-0.545994</td>
      <td>-0.354798</td>
      <td>0.314202</td>
      <td>-0.717286</td>
      <td>0.306310</td>
      <td>0.327613</td>
      <td>-0.393830</td>
      <td>2.0</td>
      <td>-0.630120</td>
      <td>2.558968</td>
      <td>2.411231</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.870473</td>
      <td>1.491318</td>
      <td>-0.047216</td>
      <td>0.122576</td>
      <td>0.275930</td>
      <td>0.556719</td>
      <td>0.165314</td>
      <td>-0.002144</td>
      <td>0.396029</td>
      <td>-0.564402</td>
      <td>3.0</td>
      <td>0.839852</td>
      <td>3.006332</td>
      <td>5.348508</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-0.152311</td>
      <td>-0.189854</td>
      <td>2.195148</td>
      <td>-0.055830</td>
      <td>0.063649</td>
      <td>0.063731</td>
      <td>-0.161977</td>
      <td>0.078423</td>
      <td>0.180978</td>
      <td>0.102862</td>
      <td>4.0</td>
      <td>2.045322</td>
      <td>0.935290</td>
      <td>4.422516</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">plotly</span> <span class="kn">import</span> <span class="n">graph_objects</span> <span class="k">as</span> <span class="n">go</span>

<span class="n">fig_clusters</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter_3d</span><span class="p">(</span>
    <span class="n">result_umap_euc</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">z</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;UMAP, clustering by leiden_clustering, with clustroids&quot;</span><span class="p">,</span>
    <span class="c1"># reduce size points</span>
    <span class="n">size_max</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="c1"># make scatter alpha = 0.1</span>
    <span class="n">opacity</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">category_orders</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span><span class="p">)))]},</span>
<span class="p">)</span>
<span class="n">fig_clusters</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
    <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">clustroids</span><span class="p">[</span><span class="s2">&quot;umap_1&quot;</span><span class="p">],</span>
        <span class="n">y</span><span class="o">=</span><span class="n">clustroids</span><span class="p">[</span><span class="s2">&quot;umap_2&quot;</span><span class="p">],</span>
        <span class="n">z</span><span class="o">=</span><span class="n">clustroids</span><span class="p">[</span><span class="s2">&quot;umap_3&quot;</span><span class="p">],</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;cross&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span>
            <span class="c1"># color=clustering.labels_.astype(str),</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Clustroids&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">fig_clusters</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;plot_bgcolor&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(0, 0, 0, 0)&quot;</span><span class="p">,</span> <span class="s2">&quot;paper_bgcolor&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(0, 0, 0, 0)&quot;</span><span class="p">}</span>
<span class="p">)</span>
<span class="n">fig_clusters</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">font_color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
<span class="n">fig_clusters</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">fig_clusters</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">legend_title_text</span><span class="o">=</span><span class="s2">&quot;Cluster&quot;</span><span class="p">)</span>
<span class="n">fig_clusters</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">,</span> <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">,</span> <span class="n">zaxis_title</span><span class="o">=</span><span class="s2">&quot;UMAP 3&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">EXPORT</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="n">EXPORT</span><span class="p">:</span>
    <span class="n">fig_clusters</span><span class="o">.</span><span class="n">write_html</span><span class="p">(</span><span class="n">FIG_PATH</span> <span class="o">/</span> <span class="s2">&quot;umap_w_clustroids.html&quot;</span><span class="p">)</span>

<span class="n">fig_clusters</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N_FOLDS</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">N_CLUSTERS</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
<span class="n">features_used</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsClassifier</span>

<span class="n">kfold</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">N_FOLDS</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">clustering_train_results</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">clustering_test_results</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">clustroids_train_results</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">clustroids_test_results</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># run clustering on each fold, stratified by origin</span>
<span class="n">cv_combined_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()[</span><span class="n">features_used</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">train_idx</span><span class="p">,</span> <span class="n">test_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
    <span class="n">kfold</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cv_combined_df</span><span class="p">[</span><span class="n">features_used</span><span class="p">],</span> <span class="n">cv_combined_df</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">])</span>
<span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fold </span><span class="si">{</span><span class="n">fold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">cv_combined_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">][</span><span class="n">features_used</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">cv_combined_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">][</span><span class="n">features_used</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trains set : </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test set : </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="c1"># find resolution parameter that leads to the previous number of clusters</span>
    <span class="n">repeat</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">resolution_parameter</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">resolution_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">]</span>
    <span class="n">step</span><span class="o">=</span><span class="mf">0.02</span>
    <span class="k">while</span> <span class="n">repeat</span><span class="p">:</span>
        <span class="c1"># fix seed for reproducibility</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Clustering train set&quot;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">train_clustering</span> <span class="o">=</span> <span class="n">LeidenClustering</span><span class="p">(</span>
            <span class="n">leiden_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;n_iterations&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;resolution_parameter&quot;</span><span class="p">:</span> <span class="n">resolution_parameter</span><span class="p">},</span>
            <span class="n">pca_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;n_components&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="n">train_clustering</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
        <span class="n">unique_labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">train_clustering</span><span class="o">.</span><span class="n">labels_</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolution parameter: </span><span class="si">{</span><span class="n">resolution_parameter</span><span class="si">}</span><span class="s2">, n groups: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)</span> <span class="o">==</span> <span class="n">N_CLUSTERS</span><span class="p">:</span>
            <span class="n">repeat</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># too many clusters, decrease resolution parameter</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">N_CLUSTERS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">resolution_parameter</span> <span class="o">-</span> <span class="n">step</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1">#send error message</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not find a resolution parameter that does not lead to more clusters than expected&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resolution_parameter</span> <span class="o">-</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">resolution_parameters</span><span class="p">:</span>
                <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="o">/</span><span class="mf">2.</span>
            <span class="n">resolution_parameter</span> <span class="o">-=</span> <span class="n">step</span>
        <span class="c1"># too few clusters, increase resolution parameter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">resolution_parameter</span> <span class="o">+</span> <span class="n">step</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1">#send error message</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not find a resolution parameter that does not lead to less clusters than expected&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resolution_parameter</span> <span class="o">+</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">resolution_parameters</span><span class="p">:</span>
                <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="o">/</span><span class="mf">2.</span>
            <span class="n">resolution_parameter</span> <span class="o">+=</span> <span class="n">step</span>
        <span class="n">resolution_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resolution_parameter</span><span class="p">)</span>

    <span class="n">X_train_w_clusters</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">combined_df</span><span class="p">[</span><span class="n">features_used</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;cluster&quot;</span><span class="p">:</span> <span class="n">train_clustering</span><span class="o">.</span><span class="n">labels_</span><span class="p">}),</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">result_umap_euc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;umap_1&quot;</span><span class="p">,</span> <span class="s2">&quot;umap_2&quot;</span><span class="p">,</span> <span class="s2">&quot;umap_3&quot;</span><span class="p">]</span>
            <span class="p">),</span>
        <span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">clustering_train_results</span><span class="p">[</span><span class="n">fold</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_train_w_clusters</span>
    <span class="c1"># compute train clustroids</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing train clustroids&quot;</span><span class="p">)</span>
    <span class="n">train_clustroids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">train_clustering</span><span class="o">.</span><span class="n">labels_</span><span class="p">):</span>
        <span class="n">clustroid</span> <span class="o">=</span> <span class="n">X_train_w_clusters</span><span class="p">[</span><span class="n">X_train_w_clusters</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cluster</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">train_clustroids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clustroid</span><span class="p">)</span>
    <span class="n">train_clustroids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">train_clustroids</span><span class="p">)</span>
    <span class="n">clustroids_train_results</span><span class="p">[</span><span class="n">fold</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_clustroids</span>

    <span class="c1"># test clustering using nearest neighbors</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Clustering test set using nearest neighbors&quot;</span><span class="p">)</span>
    <span class="n">test_clustering</span> <span class="o">=</span> <span class="n">KNeighborsClassifier</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="c1"># fit on UMAP embeddings</span>
    <span class="n">test_clustering</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">result_umap_euc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">train_clustering</span><span class="o">.</span><span class="n">labels_</span><span class="p">)</span>
    <span class="c1"># predict on UMAP embeddings</span>
    <span class="n">test_clustering</span><span class="o">.</span><span class="n">labels_</span> <span class="o">=</span> <span class="n">test_clustering</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">result_umap_euc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">])</span>

    <span class="n">X_test_w_clusters</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">combined_df</span><span class="p">[</span><span class="n">features_used</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;cluster&quot;</span><span class="p">:</span> <span class="n">test_clustering</span><span class="o">.</span><span class="n">labels_</span><span class="p">}),</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">result_umap_euc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;umap_1&quot;</span><span class="p">,</span> <span class="s2">&quot;umap_2&quot;</span><span class="p">,</span> <span class="s2">&quot;umap_3&quot;</span><span class="p">]</span>
            <span class="p">),</span>
        <span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">clustering_test_results</span><span class="p">[</span><span class="n">fold</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_test_w_clusters</span>
    <span class="c1"># find the clustroid of each cluster</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing test clustroids&quot;</span><span class="p">)</span>
    <span class="n">test_clustroids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">train_clustering</span><span class="o">.</span><span class="n">labels_</span><span class="p">):</span>
        <span class="n">clustroid</span> <span class="o">=</span> <span class="n">X_test_w_clusters</span><span class="p">[</span><span class="n">X_test_w_clusters</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cluster</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">test_clustroids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clustroid</span><span class="p">)</span>
    <span class="n">test_clustroids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">test_clustroids</span><span class="p">)</span>
    <span class="n">clustroids_test_results</span><span class="p">[</span><span class="n">fold</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_clustroids</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
        <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span>
        <span class="s2">&quot;3&quot;</span><span class="p">:</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span>
        <span class="s2">&quot;4&quot;</span><span class="p">:</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span>
        <span class="s2">&quot;5&quot;</span><span class="p">:</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># Train plot</span>
    <span class="c1"># fig = px.scatter_3d(</span>
    <span class="c1">#     result_umap_euc[train_idx],</span>
    <span class="c1">#     x=0,</span>
    <span class="c1">#     y=1,</span>
    <span class="c1">#     z=2,</span>
    <span class="c1">#     color=[colors[str(c)] for c in train_clustering.labels_],</span>
    <span class="c1">#     title=f&quot;Train : UMAP, clustering by leiden_clustering\nFold {fold}&quot;,</span>
    <span class="c1">#     # reduce size points</span>
    <span class="c1">#     size_max=0.1,</span>
    <span class="c1">#     opacity=0.1,</span>
    <span class="c1"># )</span>
    <span class="c1"># fig.show()</span>
    <span class="c1"># # Test plot</span>
    <span class="c1"># fig = px.scatter_3d(</span>
    <span class="c1">#     result_umap_euc[test_idx],</span>
    <span class="c1">#     x=0,</span>
    <span class="c1">#     y=1,</span>
    <span class="c1">#     z=2,</span>
    <span class="c1">#     color=[colors[str(c)] for c in test_clustering.labels_],</span>
    <span class="c1">#     title=f&quot;Test : UMAP, clustering by leiden_clustering\nFold {fold}&quot;,</span>
    <span class="c1">#     # reduce size points</span>
    <span class="c1">#     size_max=0.1,</span>
    <span class="c1">#     opacity=0.1,</span>
    <span class="c1"># )</span>
    <span class="c1"># fig.show()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;_&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fold 0
Trains set : (50493, 10)
Test set : (12624, 10)
Clustering train set
Resolution parameter: 0.2, n groups: 5
Computing train clustroids
Clustering test set using nearest neighbors
Computing test clustroids
________________________________________________________________________________
Fold 1
Trains set : (50493, 10)
Test set : (12624, 10)
Clustering train set
Resolution parameter: 0.2, n groups: 5
Computing train clustroids
Clustering test set using nearest neighbors
Computing test clustroids
________________________________________________________________________________
Fold 2
Trains set : (50494, 10)
Test set : (12623, 10)
Clustering train set
Resolution parameter: 0.2, n groups: 5
Computing train clustroids
Clustering test set using nearest neighbors
Computing test clustroids
________________________________________________________________________________
Fold 3
Trains set : (50494, 10)
Test set : (12623, 10)
Clustering train set
Resolution parameter: 0.2, n groups: 6
Clustering train set
Resolution parameter: 0.18000000000000002, n groups: 5
Computing train clustroids
Clustering test set using nearest neighbors
Computing test clustroids
________________________________________________________________________________
Fold 4
Trains set : (50494, 10)
Test set : (12623, 10)
Clustering train set
Resolution parameter: 0.2, n groups: 4
Clustering train set
Resolution parameter: 0.22, n groups: 5
Computing train clustroids
Clustering test set using nearest neighbors
Computing test clustroids
________________________________________________________________________________
</pre></div>
</div>
</div>
</div>
</section>
<section id="assessing-the-variability-of-the-clustering-across-folds">
<h2>Assessing the variability of the clustering across folds<a class="headerlink" href="#assessing-the-variability-of-the-clustering-across-folds" title="Permalink to this heading">#</a></h2>
<p>We now face a problem linked to the implementation of Leiden : the cluster labels are not consistent across folds.</p>
<p>Therefore, if we now try to compare distributions of cluster features across folds, we will not be able to compare properly the clusters.</p>
<p>Below we show the means of each feature across clusters, for each fold; where the issue is readily apparent.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># barplot of the mean of each feature for all the train sets</span>
<span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">clustering_train_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;fold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fold</span>
<span class="n">train_features_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">clustering_train_results</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">train_features_df</span> <span class="o">=</span> <span class="n">train_features_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;fold&quot;</span><span class="p">,</span> <span class="s2">&quot;cluster&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Train set features means per cluster&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">features_used</span><span class="p">):</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">train_features_df</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;fold&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span>
        <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span>
        <span class="n">errorbar</span><span class="o">=</span><span class="s2">&quot;ci&quot;</span><span class="p">,</span>
        <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;tab10&quot;</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Fold&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Feature value&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f100fb9adf54cae150ad6845b61003eff655bcf18dcba280c7db3a548606d5fc.png" src="_images/f100fb9adf54cae150ad6845b61003eff655bcf18dcba280c7db3a548606d5fc.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">clustering_test_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;fold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fold</span>
<span class="n">test_features_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">clustering_test_results</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_features_df</span> <span class="o">=</span> <span class="n">test_features_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;fold&quot;</span><span class="p">,</span> <span class="s2">&quot;cluster&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">test_features_df</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Test set features means per cluster&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">features_used</span><span class="p">):</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">test_features_df</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;fold&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span>
        <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span>
        <span class="n">errorbar</span><span class="o">=</span><span class="s2">&quot;ci&quot;</span><span class="p">,</span>
        <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;tab10&quot;</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Fold&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Feature value&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f950579f5ccd62102ae044d5a5bbb87b9cc6a423e2f1be1e5e8edba1eb0c5612.png" src="_images/f950579f5ccd62102ae044d5a5bbb87b9cc6a423e2f1be1e5e8edba1eb0c5612.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">fold</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clustroids_test_results</span><span class="p">)):</span>
    <span class="n">clustroids_test_results</span><span class="p">[</span><span class="n">fold</span><span class="p">][</span><span class="s2">&quot;fold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fold</span>

<span class="n">clustroids_test_results_tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">clustroids_test_results</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">test_clustroids</span> <span class="o">=</span> <span class="n">clustroids_test_results_tmp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;fold&quot;</span><span class="p">,</span> <span class="s2">&quot;cluster&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">clustroid_coordinates</span> <span class="o">=</span> <span class="n">test_clustroids</span><span class="p">[[</span><span class="s2">&quot;umap_1&quot;</span><span class="p">,</span> <span class="s2">&quot;umap_2&quot;</span><span class="p">,</span> <span class="s2">&quot;umap_3&quot;</span><span class="p">]]</span>
<span class="n">display</span><span class="p">(</span><span class="n">clustroid_coordinates</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>umap_1</th>
      <th>umap_2</th>
      <th>umap_3</th>
    </tr>
    <tr>
      <th>fold</th>
      <th>cluster</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">0</th>
      <th>0.0</th>
      <td>-0.367219</td>
      <td>2.847011</td>
      <td>2.377605</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>9.038926</td>
      <td>1.241969</td>
      <td>6.633843</td>
    </tr>
    <tr>
      <th>2.0</th>
      <td>0.494159</td>
      <td>2.349472</td>
      <td>5.235715</td>
    </tr>
    <tr>
      <th>3.0</th>
      <td>0.625342</td>
      <td>3.394092</td>
      <td>5.841272</td>
    </tr>
    <tr>
      <th>4.0</th>
      <td>1.895067</td>
      <td>0.568144</td>
      <td>5.098432</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">1</th>
      <th>0.0</th>
      <td>0.527236</td>
      <td>2.632872</td>
      <td>4.624590</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>9.069517</td>
      <td>1.173576</td>
      <td>6.587983</td>
    </tr>
    <tr>
      <th>2.0</th>
      <td>-0.552488</td>
      <td>2.750510</td>
      <td>2.042750</td>
    </tr>
    <tr>
      <th>3.0</th>
      <td>0.692302</td>
      <td>3.364044</td>
      <td>5.887834</td>
    </tr>
    <tr>
      <th>4.0</th>
      <td>2.297152</td>
      <td>0.647605</td>
      <td>5.071100</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">2</th>
      <th>0.0</th>
      <td>-0.463544</td>
      <td>2.920113</td>
      <td>3.451505</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>9.165118</td>
      <td>1.271744</td>
      <td>6.559513</td>
    </tr>
    <tr>
      <th>2.0</th>
      <td>1.617070</td>
      <td>2.020344</td>
      <td>3.875351</td>
    </tr>
    <tr>
      <th>3.0</th>
      <td>0.668133</td>
      <td>3.443437</td>
      <td>6.149098</td>
    </tr>
    <tr>
      <th>4.0</th>
      <td>2.248706</td>
      <td>0.739716</td>
      <td>4.928270</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">3</th>
      <th>0.0</th>
      <td>-0.575766</td>
      <td>2.903790</td>
      <td>3.509942</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>9.095668</td>
      <td>1.317988</td>
      <td>6.649416</td>
    </tr>
    <tr>
      <th>2.0</th>
      <td>0.678652</td>
      <td>2.400847</td>
      <td>3.245425</td>
    </tr>
    <tr>
      <th>3.0</th>
      <td>0.841541</td>
      <td>3.352670</td>
      <td>5.972459</td>
    </tr>
    <tr>
      <th>4.0</th>
      <td>2.334850</td>
      <td>0.647066</td>
      <td>5.078170</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">4</th>
      <th>0.0</th>
      <td>1.631184</td>
      <td>2.027702</td>
      <td>4.338274</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>-0.438033</td>
      <td>2.798249</td>
      <td>3.106534</td>
    </tr>
    <tr>
      <th>2.0</th>
      <td>9.365258</td>
      <td>1.659720</td>
      <td>6.382227</td>
    </tr>
    <tr>
      <th>3.0</th>
      <td>0.499260</td>
      <td>3.431417</td>
      <td>5.997583</td>
    </tr>
    <tr>
      <th>4.0</th>
      <td>2.410004</td>
      <td>0.853439</td>
      <td>5.174749</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="matching-to-the-rescue">
<h2>Matching to the rescue<a class="headerlink" href="#matching-to-the-rescue" title="Permalink to this heading">#</a></h2>
<p>However, there is a way to prevent this issue : matching. To do this, we can assign the nearest clustroids for a given fold to the closest ones across other folds.
This way, we can compare the clusters by assigning them to other clusters that are likely the same.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nearest_clustroids</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1"># report which cluster to match with which in other folds</span>
<span class="c1"># in the format (fold_i, cluster_i) : {fold_j1, cluster_j1, distance_j1}, {fold_j2, cluster_j2, distance_j2}, ...</span>
<span class="c1"># of shape n_folds x n_clusters x n_clusters-1</span>
<span class="k">for</span> <span class="n">fold_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_FOLDS</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">cluster_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_CLUSTERS</span><span class="p">):</span>
        <span class="n">nearest_clustroids</span><span class="p">[(</span><span class="n">fold_i</span><span class="p">,</span> <span class="n">cluster_i</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fold_j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_FOLDS</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fold_i</span> <span class="o">==</span> <span class="n">fold_j</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">cluster_j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_CLUSTERS</span><span class="p">):</span>
                <span class="n">distances</span><span class="p">[</span><span class="n">fold_j</span><span class="p">,</span> <span class="n">cluster_j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                    <span class="n">clustroid_coordinates</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fold_i</span><span class="p">,</span> <span class="n">cluster_i</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">clustroid_coordinates</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fold_j</span><span class="p">,</span> <span class="n">cluster_j</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="c1"># find minimum distance and append according to format</span>
            <span class="c1"># print(list(distances.values()))</span>
            <span class="n">min_dist_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">distances</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="n">nearest_clustroids</span><span class="p">[(</span><span class="n">fold_i</span><span class="p">,</span> <span class="n">cluster_i</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">fold_j</span><span class="p">,</span> <span class="n">min_dist_id</span><span class="p">,</span> <span class="n">distances</span><span class="p">[</span><span class="n">fold_j</span><span class="p">,</span> <span class="n">min_dist_id</span><span class="p">])</span>
            <span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">nearest_clustroids</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{(0, 0): [(1, 2, 0.39467028580557895),
  (2, 0, 1.0806868960865863),
  (3, 0, 1.1527806796991444),
  (4, 1, 0.7339827457851795)],
 (0, 1): [(1, 1, 0.08784386688488575),
  (2, 1, 0.1494524568809154),
  (3, 1, 0.09613104986711174),
  (4, 2, 0.5867873248553004)],
 (0, 2): [(1, 0, 0.6744498676524991),
  (2, 3, 1.4357206884835976),
  (3, 3, 1.2922350076504032),
  (4, 3, 1.3232816996270647)],
 (0, 3): [(1, 3, 0.08691712267048904),
  (2, 3, 0.31467891445677865),
  (3, 3, 0.25625706276011023),
  (4, 3, 0.20426237817383752)],
 (0, 4): [(1, 4, 0.4107721901127088),
  (2, 4, 0.4283145962690895),
  (3, 4, 0.44726844751255507),
  (4, 4, 0.5936147420399945)],
 (1, 0): [(0, 2, 0.6744498676524991),
  (2, 2, 1.4574930956882797),
  (3, 2, 1.4067191126743162),
  (4, 0, 1.2910881854645704)],
 (1, 1): [(0, 1, 0.08784386688488575),
  (2, 1, 0.13995414561907316),
  (3, 1, 0.15910053349536676),
  (4, 2, 0.6050903138646051)],
 (1, 2): [(0, 0, 0.39467028580557895),
  (2, 0, 1.421712460441738),
  (3, 0, 1.47536026590293),
  (4, 1, 1.0709881054577421)],
 (1, 3): [(0, 3, 0.08691712267048904),
  (2, 3, 0.27412854760729094),
  (3, 3, 0.1719385026174115),
  (4, 3, 0.23205506740655624)],
 (1, 4): [(0, 4, 0.4107721901127088),
  (2, 4, 0.17672584339399672),
  (3, 4, 0.038359201862067066),
  (4, 4, 0.256605702015804)],
 (2, 0): [(0, 0, 1.0806868960865863),
  (1, 2, 1.421712460441738),
  (3, 0, 0.12757445389417643),
  (4, 1, 0.36675136361989147)],
 (2, 1): [(0, 1, 0.1494524568809154),
  (1, 1, 0.13995414561907316),
  (3, 1, 0.12265632830184735),
  (4, 2, 0.47118074045187064)],
 (2, 2): [(0, 2, 1.7943925129506775),
  (1, 0, 1.4574930956882797),
  (3, 2, 1.1925668573640613),
  (4, 0, 0.46319733622013065)],
 (2, 3): [(0, 3, 0.31467891445677865),
  (1, 3, 0.27412854760729094),
  (3, 3, 0.2636481392594869),
  (4, 3, 0.22719834465729183)],
 (2, 4): [(0, 4, 0.4283145962690895),
  (1, 4, 0.17672584339399672),
  (3, 4, 0.19614986669806111),
  (4, 4, 0.31575624249787)],
 (3, 0): [(0, 0, 1.1527806796991444),
  (1, 2, 1.47536026590293),
  (2, 0, 0.12757445389417643),
  (4, 1, 0.4391435910282246)],
 (3, 1): [(0, 1, 0.09613104986711174),
  (1, 1, 0.15910053349536676),
  (2, 1, 0.12265632830184735),
  (4, 2, 0.5107342556962734)],
 (3, 2): [(0, 0, 1.4303916926798308),
  (1, 0, 1.4067191126743162),
  (2, 2, 1.1925668573640613),
  (4, 1, 1.1934003139515095)],
 (3, 3): [(0, 3, 0.25625706276011023),
  (1, 3, 0.1719385026174115),
  (2, 3, 0.2636481392594869),
  (4, 3, 0.3521198992823031)],
 (3, 4): [(0, 4, 0.44726844751255507),
  (1, 4, 0.038359201862067066),
  (2, 4, 0.19614986669806111),
  (4, 4, 0.23992783364557735)],
 (4, 0): [(0, 2, 1.4838338389932297),
  (1, 0, 1.2910881854645704),
  (2, 2, 0.46319733622013065),
  (3, 2, 1.4969551448331748)],
 (4, 1): [(0, 0, 0.7339827457851795),
  (1, 2, 1.0709881054577421),
  (2, 0, 0.36675136361989147),
  (3, 0, 0.4391435910282246)],
 (4, 2): [(0, 1, 0.5867873248553004),
  (1, 1, 0.6050903138646051),
  (2, 1, 0.47118074045187064),
  (3, 1, 0.5107342556962734)],
 (4, 3): [(0, 3, 0.20426237817383752),
  (1, 3, 0.23205506740655624),
  (2, 3, 0.22719834465729183),
  (3, 3, 0.3521198992823031)],
 (4, 4): [(0, 4, 0.5936147420399945),
  (1, 4, 0.256605702015804),
  (2, 4, 0.31575624249787),
  (3, 4, 0.23992783364557735)]}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># make a dataframe that shows for folds : cluster_from, cluster_to, fold, distance</span>
<span class="n">matched_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fold_from&quot;</span><span class="p">,</span> <span class="s2">&quot;cluster_from&quot;</span><span class="p">,</span> <span class="s2">&quot;fold_to&quot;</span><span class="p">,</span> <span class="s2">&quot;cluster_to&quot;</span><span class="p">,</span> <span class="s2">&quot;distance&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">fold_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_FOLDS</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">cluster_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_CLUSTERS</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fold_j</span><span class="p">,</span> <span class="n">cluster_j</span><span class="p">,</span> <span class="n">distance</span> <span class="ow">in</span> <span class="n">nearest_clustroids</span><span class="p">[(</span><span class="n">fold_i</span><span class="p">,</span> <span class="n">cluster_i</span><span class="p">)]:</span>
            <span class="n">matched_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">matched_df</span><span class="p">,</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;fold_from&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">fold_i</span><span class="p">],</span>
                            <span class="s2">&quot;cluster_from&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">cluster_i</span><span class="p">],</span>
                            <span class="s2">&quot;fold_to&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">fold_j</span><span class="p">],</span>
                            <span class="s2">&quot;cluster_to&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">cluster_j</span><span class="p">],</span>
                            <span class="s2">&quot;distance&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">distance</span><span class="p">],</span>
                        <span class="p">}</span>
                    <span class="p">),</span>
                <span class="p">]</span>
            <span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">matched_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fold_from</th>
      <th>cluster_from</th>
      <th>fold_to</th>
      <th>cluster_to</th>
      <th>distance</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>0.394670</td>
    </tr>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>1.080687</td>
    </tr>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>1.152781</td>
    </tr>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>4</td>
      <td>1</td>
      <td>0.733983</td>
    </tr>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0.087844</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>0</th>
      <td>4</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>0.352120</td>
    </tr>
    <tr>
      <th>0</th>
      <td>4</td>
      <td>4</td>
      <td>0</td>
      <td>4</td>
      <td>0.593615</td>
    </tr>
    <tr>
      <th>0</th>
      <td>4</td>
      <td>4</td>
      <td>1</td>
      <td>4</td>
      <td>0.256606</td>
    </tr>
    <tr>
      <th>0</th>
      <td>4</td>
      <td>4</td>
      <td>2</td>
      <td>4</td>
      <td>0.315756</td>
    </tr>
    <tr>
      <th>0</th>
      <td>4</td>
      <td>4</td>
      <td>3</td>
      <td>4</td>
      <td>0.239928</td>
    </tr>
  </tbody>
</table>
<p>100 rows × 5 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">extract_fold_coordinates</span><span class="p">(</span><span class="n">fold</span><span class="p">,</span> <span class="n">matched_df</span><span class="o">=</span><span class="n">matched_df</span><span class="p">):</span>
    <span class="n">matched_df</span> <span class="o">=</span> <span class="n">matched_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">matched_df</span><span class="p">[</span><span class="s2">&quot;fold_from&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fold</span><span class="p">]</span>
    <span class="n">coordinates_matched</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cluster_from</span> <span class="ow">in</span> <span class="n">matched_df</span><span class="p">[</span><span class="s2">&quot;cluster_from&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">coordinates_matched</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">clustroid_coordinates</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fold</span><span class="p">,</span> <span class="n">cluster_from</span><span class="p">]])</span>
        <span class="n">other_coords</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">clustroid_coordinates</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">matched_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">matched_df</span><span class="p">[</span><span class="s2">&quot;cluster_from&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cluster_from</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">matched_df</span><span class="p">[</span><span class="s2">&quot;cluster_to&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cluster_to</span><span class="p">)</span>
                <span class="p">][</span><span class="s2">&quot;fold_to&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">cluster_to</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">cluster_to</span> <span class="ow">in</span> <span class="n">matched_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span><span class="n">matched_df</span><span class="p">[</span><span class="s2">&quot;cluster_from&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cluster_from</span><span class="p">)</span>
            <span class="p">][</span><span class="s2">&quot;cluster_to&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="p">]</span>
        <span class="n">coordinates_matched</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">other_coords</span><span class="p">)</span>
    <span class="n">coordinates_matched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">coordinates_matched</span>
    <span class="p">)</span>  <span class="c1"># shape is N_FOLDS x N_CLUSTERS x 3</span>
    <span class="n">coordinates_matched</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">coordinates_matched</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N_CLUSTERS</span> <span class="o">*</span> <span class="n">N_FOLDS</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;umap_1&quot;</span><span class="p">,</span> <span class="s2">&quot;umap_2&quot;</span><span class="p">,</span> <span class="s2">&quot;umap_3&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">coordinates_matched</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N_CLUSTERS</span><span class="p">),</span> <span class="n">N_FOLDS</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coordinates_matched</span>


<span class="n">coordinates_matched_fold0</span> <span class="o">=</span> <span class="n">extract_fold_coordinates</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="plot-of-clustroids-variation-across-folds">
<h3>Plot of clustroids variation across folds<a class="headerlink" href="#plot-of-clustroids-variation-across-folds" title="Permalink to this heading">#</a></h3>
<p>Now that we have matched the clusters, we can start comparing them across folds.
In the following plot, we show the clustroids of each fold, matched to the clustroids of the fourth fold.
The clustroids are overall similar across folds, and match the ones in the original clustering in the data, demonstrating a degree of robustness of the clustering.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we use the fourth fold as it contains the best matchings</span>
<span class="n">coordinates_matched_fold4</span> <span class="o">=</span> <span class="n">extract_fold_coordinates</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter_3d</span><span class="p">(</span>
    <span class="n">coordinates_matched_fold4</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;umap_1&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;umap_2&quot;</span><span class="p">,</span>
    <span class="n">z</span><span class="o">=</span><span class="s2">&quot;umap_3&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Variability of clustroids across folds&quot;</span><span class="p">,</span>
    <span class="n">opacity</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="n">symbol</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span>
    <span class="c1"># color_continuous_scale=px.colors.sequential.haline,</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
    <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">clustroids</span><span class="p">[</span><span class="s2">&quot;umap_1&quot;</span><span class="p">],</span>
        <span class="n">y</span><span class="o">=</span><span class="n">clustroids</span><span class="p">[</span><span class="s2">&quot;umap_2&quot;</span><span class="p">],</span>
        <span class="n">z</span><span class="o">=</span><span class="n">clustroids</span><span class="p">[</span><span class="s2">&quot;umap_3&quot;</span><span class="p">],</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;cross&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span>
            <span class="c1"># color=clustering.labels_.astype(str),</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Original clustroids&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">fig_clusters</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;plot_bgcolor&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(0, 0, 0, 0)&quot;</span><span class="p">,</span> <span class="s2">&quot;paper_bgcolor&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(0, 0, 0, 0)&quot;</span><span class="p">}</span>
<span class="p">)</span>
<span class="n">fig_clusters</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">font_color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
<span class="n">fig_clusters</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">fig_clusters</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">legend_title_text</span><span class="o">=</span><span class="s2">&quot;Cluster&quot;</span><span class="p">)</span>
<span class="n">fig_clusters</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">,</span> <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">,</span> <span class="n">zaxis_title</span><span class="o">=</span><span class="s2">&quot;UMAP 3&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">yanchor</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
        <span class="n">xanchor</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">),</span>
        <span class="n">bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Fold&quot;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)),</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_coloraxes</span><span class="p">(</span><span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">))))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_coloraxes</span><span class="p">(</span><span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">tickfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)))</span>

<span class="k">if</span> <span class="n">EXPORT</span><span class="p">:</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">write_html</span><span class="p">(</span><span class="n">FIG_PATH</span> <span class="o">/</span> <span class="s2">&quot;clustroids_variability.html&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">matched_df_fold4</span> <span class="o">=</span> <span class="n">matched_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">matched_df</span><span class="p">[</span><span class="s2">&quot;fold_from&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">]</span>
<span class="c1"># display(matched_df_fold4)</span>

<span class="c1"># get the features using cluster matching from fold 4</span>
<span class="n">features_matched</span> <span class="o">=</span> <span class="n">test_features_df</span>
<span class="c1"># reorder using the matched_df_fold4</span>
<span class="c1"># display(features_matched)</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">matched_features_means</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">features_matched</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">matched_df_fold4</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;cluster_from&quot;</span><span class="p">]:</span>
        <span class="c1"># append the row from fold 4</span>
        <span class="n">new_row</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">features_matched</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span><span class="n">features_matched</span><span class="p">[</span><span class="s2">&quot;fold&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">features_matched</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;cluster_from&quot;</span><span class="p">])</span>
            <span class="p">]</span>
            <span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="c1"># print(new_row)</span>
        <span class="n">matched_features_means</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">matched_features_means</span><span class="p">)]</span> <span class="o">=</span> <span class="n">new_row</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># find fold_to and cluster_to in fold and cluster columns of matched_df_fold4</span>
    <span class="n">new_row</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">features_matched</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">features_matched</span><span class="p">[</span><span class="s2">&quot;fold&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;fold_to&quot;</span><span class="p">])</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">features_matched</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;cluster_to&quot;</span><span class="p">])</span>
        <span class="p">]</span>
        <span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="c1"># print(new_row)</span>
    <span class="n">matched_features_means</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">matched_features_means</span><span class="p">)]</span> <span class="o">=</span> <span class="n">new_row</span>
<span class="n">matched_features_means</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fold</th>
      <th>cluster</th>
      <th>durationInSec</th>
      <th>backtrack</th>
      <th>numberOfPath</th>
      <th>position_mean</th>
      <th>position_std</th>
      <th>path_length</th>
      <th>coarse_mean_time</th>
      <th>semantic_similarity</th>
      <th>ratio</th>
      <th>path_closeness_abs_sum</th>
      <th>umap_1</th>
      <th>umap_2</th>
      <th>umap_3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>4.0</td>
      <td>0.0</td>
      <td>0.467695</td>
      <td>-0.153092</td>
      <td>-0.273994</td>
      <td>0.517576</td>
      <td>0.600389</td>
      <td>0.195799</td>
      <td>0.545493</td>
      <td>-0.183928</td>
      <td>0.294102</td>
      <td>0.195605</td>
      <td>1.631184</td>
      <td>2.027702</td>
      <td>4.338274</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.0</td>
      <td>2.0</td>
      <td>0.578309</td>
      <td>-0.123091</td>
      <td>-0.335148</td>
      <td>0.131691</td>
      <td>0.513015</td>
      <td>0.865630</td>
      <td>0.277820</td>
      <td>0.218363</td>
      <td>0.349143</td>
      <td>-1.106847</td>
      <td>0.494159</td>
      <td>2.349472</td>
      <td>5.235715</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.607554</td>
      <td>-0.124822</td>
      <td>-0.310035</td>
      <td>0.061025</td>
      <td>0.320233</td>
      <td>0.667750</td>
      <td>0.432782</td>
      <td>0.207143</td>
      <td>0.372179</td>
      <td>-0.592349</td>
      <td>0.527236</td>
      <td>2.632872</td>
      <td>4.624590</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2.0</td>
      <td>2.0</td>
      <td>0.686405</td>
      <td>-0.148206</td>
      <td>-0.327783</td>
      <td>0.606981</td>
      <td>0.637584</td>
      <td>0.207167</td>
      <td>0.823426</td>
      <td>-0.280753</td>
      <td>0.297195</td>
      <td>0.339170</td>
      <td>1.617070</td>
      <td>2.020344</td>
      <td>3.875351</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3.0</td>
      <td>2.0</td>
      <td>0.181559</td>
      <td>-0.188544</td>
      <td>-0.224822</td>
      <td>0.550900</td>
      <td>0.577611</td>
      <td>0.029719</td>
      <td>0.291457</td>
      <td>-0.326842</td>
      <td>0.514503</td>
      <td>0.557388</td>
      <td>0.678652</td>
      <td>2.400847</td>
      <td>3.245425</td>
    </tr>
    <tr>
      <th>5</th>
      <td>4.0</td>
      <td>1.0</td>
      <td>-0.279962</td>
      <td>-0.199945</td>
      <td>-0.212194</td>
      <td>-0.459536</td>
      <td>-0.238472</td>
      <td>0.373491</td>
      <td>-0.506608</td>
      <td>0.333263</td>
      <td>0.392367</td>
      <td>-0.383394</td>
      <td>-0.438033</td>
      <td>2.798249</td>
      <td>3.106534</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>-0.114235</td>
      <td>-0.210244</td>
      <td>-0.206718</td>
      <td>0.030370</td>
      <td>0.092120</td>
      <td>0.066457</td>
      <td>-0.102786</td>
      <td>-0.044546</td>
      <td>0.556658</td>
      <td>0.439609</td>
      <td>-0.367219</td>
      <td>2.847011</td>
      <td>2.377605</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1.0</td>
      <td>2.0</td>
      <td>-0.436330</td>
      <td>-0.235628</td>
      <td>-0.165763</td>
      <td>0.017393</td>
      <td>0.065484</td>
      <td>-0.088692</td>
      <td>-0.414928</td>
      <td>-0.116494</td>
      <td>0.568933</td>
      <td>0.520611</td>
      <td>-0.552488</td>
      <td>2.750510</td>
      <td>2.042750</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2.0</td>
      <td>0.0</td>
      <td>-0.114126</td>
      <td>-0.195399</td>
      <td>-0.235022</td>
      <td>-0.237876</td>
      <td>0.001682</td>
      <td>0.372158</td>
      <td>-0.292958</td>
      <td>0.229395</td>
      <td>0.500475</td>
      <td>-0.288187</td>
      <td>-0.463544</td>
      <td>2.920113</td>
      <td>3.451505</td>
    </tr>
    <tr>
      <th>9</th>
      <td>3.0</td>
      <td>0.0</td>
      <td>0.121332</td>
      <td>-0.173287</td>
      <td>-0.257018</td>
      <td>-0.299862</td>
      <td>-0.040069</td>
      <td>0.552121</td>
      <td>-0.103513</td>
      <td>0.297555</td>
      <td>0.452764</td>
      <td>-0.554262</td>
      <td>-0.575767</td>
      <td>2.903790</td>
      <td>3.509942</td>
    </tr>
    <tr>
      <th>10</th>
      <td>4.0</td>
      <td>2.0</td>
      <td>-0.854225</td>
      <td>-0.193993</td>
      <td>-0.170979</td>
      <td>-0.328237</td>
      <td>-0.828019</td>
      <td>-1.091218</td>
      <td>-0.399533</td>
      <td>-0.082069</td>
      <td>-1.256811</td>
      <td>0.402434</td>
      <td>9.365258</td>
      <td>1.659720</td>
      <td>6.382227</td>
    </tr>
    <tr>
      <th>11</th>
      <td>0.0</td>
      <td>1.0</td>
      <td>-0.589302</td>
      <td>-0.184552</td>
      <td>-0.171712</td>
      <td>-0.148886</td>
      <td>-0.588009</td>
      <td>-0.905000</td>
      <td>-0.166831</td>
      <td>-0.091251</td>
      <td>-1.191682</td>
      <td>0.331012</td>
      <td>9.038926</td>
      <td>1.241969</td>
      <td>6.633843</td>
    </tr>
    <tr>
      <th>12</th>
      <td>1.0</td>
      <td>1.0</td>
      <td>-0.650526</td>
      <td>-0.190969</td>
      <td>-0.193099</td>
      <td>-0.099927</td>
      <td>-0.541820</td>
      <td>-0.967335</td>
      <td>-0.209924</td>
      <td>-0.171714</td>
      <td>-1.200423</td>
      <td>0.369289</td>
      <td>9.069517</td>
      <td>1.173576</td>
      <td>6.587983</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2.0</td>
      <td>1.0</td>
      <td>-0.737635</td>
      <td>-0.184650</td>
      <td>-0.190096</td>
      <td>-0.167258</td>
      <td>-0.621366</td>
      <td>-0.987524</td>
      <td>-0.315026</td>
      <td>-0.141509</td>
      <td>-1.214865</td>
      <td>0.378605</td>
      <td>9.165118</td>
      <td>1.271744</td>
      <td>6.559512</td>
    </tr>
    <tr>
      <th>14</th>
      <td>3.0</td>
      <td>1.0</td>
      <td>-0.664897</td>
      <td>-0.191636</td>
      <td>-0.167502</td>
      <td>-0.225288</td>
      <td>-0.617670</td>
      <td>-0.913348</td>
      <td>-0.255284</td>
      <td>-0.083197</td>
      <td>-1.200405</td>
      <td>0.339720</td>
      <td>9.095668</td>
      <td>1.317988</td>
      <td>6.649416</td>
    </tr>
    <tr>
      <th>15</th>
      <td>4.0</td>
      <td>3.0</td>
      <td>1.164995</td>
      <td>1.941046</td>
      <td>-0.005324</td>
      <td>0.019893</td>
      <td>0.227554</td>
      <td>0.799314</td>
      <td>0.346138</td>
      <td>0.081202</td>
      <td>0.503282</td>
      <td>-0.892945</td>
      <td>0.499260</td>
      <td>3.431417</td>
      <td>5.997583</td>
    </tr>
    <tr>
      <th>16</th>
      <td>0.0</td>
      <td>3.0</td>
      <td>1.198028</td>
      <td>1.920449</td>
      <td>-0.023853</td>
      <td>0.081812</td>
      <td>0.258447</td>
      <td>0.762535</td>
      <td>0.385493</td>
      <td>0.009744</td>
      <td>0.466551</td>
      <td>-0.787701</td>
      <td>0.625342</td>
      <td>3.394092</td>
      <td>5.841272</td>
    </tr>
    <tr>
      <th>17</th>
      <td>1.0</td>
      <td>3.0</td>
      <td>1.179721</td>
      <td>2.021901</td>
      <td>-0.009449</td>
      <td>0.039223</td>
      <td>0.211256</td>
      <td>0.739979</td>
      <td>0.350289</td>
      <td>0.014566</td>
      <td>0.450268</td>
      <td>-0.737974</td>
      <td>0.692302</td>
      <td>3.364044</td>
      <td>5.887834</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2.0</td>
      <td>3.0</td>
      <td>1.222546</td>
      <td>1.978735</td>
      <td>-0.066201</td>
      <td>-0.031656</td>
      <td>0.225703</td>
      <td>0.827442</td>
      <td>0.397537</td>
      <td>0.125159</td>
      <td>0.482162</td>
      <td>-0.789434</td>
      <td>0.668133</td>
      <td>3.443437</td>
      <td>6.149098</td>
    </tr>
    <tr>
      <th>19</th>
      <td>3.0</td>
      <td>3.0</td>
      <td>1.177769</td>
      <td>2.045068</td>
      <td>-0.005628</td>
      <td>0.038809</td>
      <td>0.220728</td>
      <td>0.729696</td>
      <td>0.347801</td>
      <td>0.040484</td>
      <td>0.423494</td>
      <td>-0.744414</td>
      <td>0.841541</td>
      <td>3.352670</td>
      <td>5.972458</td>
    </tr>
    <tr>
      <th>20</th>
      <td>4.0</td>
      <td>4.0</td>
      <td>-0.056296</td>
      <td>-0.151111</td>
      <td>2.626449</td>
      <td>0.055508</td>
      <td>0.114909</td>
      <td>0.057669</td>
      <td>-0.048569</td>
      <td>0.067081</td>
      <td>0.243806</td>
      <td>0.135939</td>
      <td>2.410004</td>
      <td>0.853439</td>
      <td>5.174749</td>
    </tr>
    <tr>
      <th>21</th>
      <td>0.0</td>
      <td>4.0</td>
      <td>-0.016883</td>
      <td>-0.129204</td>
      <td>2.646013</td>
      <td>-0.008160</td>
      <td>0.088551</td>
      <td>0.112831</td>
      <td>-0.044927</td>
      <td>0.049994</td>
      <td>0.283049</td>
      <td>0.033217</td>
      <td>1.895067</td>
      <td>0.568144</td>
      <td>5.098432</td>
    </tr>
    <tr>
      <th>22</th>
      <td>1.0</td>
      <td>4.0</td>
      <td>-0.083485</td>
      <td>-0.140542</td>
      <td>2.589845</td>
      <td>0.015197</td>
      <td>0.049136</td>
      <td>0.059517</td>
      <td>-0.093571</td>
      <td>0.073651</td>
      <td>0.224885</td>
      <td>0.076526</td>
      <td>2.297152</td>
      <td>0.647605</td>
      <td>5.071100</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2.0</td>
      <td>4.0</td>
      <td>-0.118572</td>
      <td>-0.114142</td>
      <td>2.558965</td>
      <td>0.043402</td>
      <td>0.114082</td>
      <td>0.037977</td>
      <td>-0.144646</td>
      <td>0.029676</td>
      <td>0.221271</td>
      <td>0.050708</td>
      <td>2.248706</td>
      <td>0.739716</td>
      <td>4.928270</td>
    </tr>
    <tr>
      <th>24</th>
      <td>3.0</td>
      <td>4.0</td>
      <td>0.000598</td>
      <td>-0.149247</td>
      <td>2.665817</td>
      <td>-0.039700</td>
      <td>0.119170</td>
      <td>0.139950</td>
      <td>-0.025652</td>
      <td>0.039526</td>
      <td>0.227913</td>
      <td>0.070328</td>
      <td>2.334850</td>
      <td>0.647066</td>
      <td>5.078169</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="variability-of-features-across-folds-in-matched-clusters">
<h2>Variability of features across folds in matched clusters<a class="headerlink" href="#variability-of-features-across-folds-in-matched-clusters" title="Permalink to this heading">#</a></h2>
<p>Finally, we can compare the distributions of features across folds, in the matched clusters.</p>
<p>It is possible that due to how the matching was performed (using clustroid distances in the UMAP latent space generated from all data points),
the clusters are not matched properly when we go back to feature space.</p>
<p>However, the distributions of features across folds are still very similar in most cases.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">matched_features_means</span><span class="p">[</span><span class="s2">&quot;matched_cluster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">feature_names_titles</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Duration&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Number of backtracks&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Number of played games&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mean of link positions&quot;</span><span class="p">,</span>
    <span class="s2">&quot;STD of link positions&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Path length&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Coarse mean time&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Semantic similarity&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Average time spent on page&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ratio&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Path closeness absolute sum&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
<span class="c1"># fig.tight_layout()</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">features_used</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">matched_features_means</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;matched_cluster&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span>
        <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;fold&quot;</span><span class="p">,</span>
        <span class="n">errorbar</span><span class="o">=</span><span class="s2">&quot;ci&quot;</span><span class="p">,</span>
        <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;tab10&quot;</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Matched clusters&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Feature value&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">feature_names_titles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># export with transparent background</span>
<span class="k">if</span> <span class="n">EXPORT</span><span class="p">:</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
        <span class="n">FIG_PATH</span> <span class="o">/</span> <span class="s2">&quot;CV_matched_clusters_feattures_means_results.png&quot;</span><span class="p">,</span>
        <span class="n">transparent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
        <span class="n">pad_inches</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b8294237db3b04e52797a451ac3b0df92843926f12ab9aea96cdf45d34a3e446.png" src="_images/b8294237db3b04e52797a451ac3b0df92843926f12ab9aea96cdf45d34a3e446.png" />
</div>
</div>
</section>
<section id="clustering-with-the-timeouts">
<h2>Clustering with the timeouts<a class="headerlink" href="#clustering-with-the-timeouts" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_finished_paths</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;combined_metrics_finished_paths&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">features_unfinished_paths</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;combined_metrics_unfinished_paths&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
    <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">features_finished_paths</span><span class="p">,</span> <span class="n">features_unfinished_paths</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;finished&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">features_finished_paths</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span>
    <span class="n">features_unfinished_paths</span>
<span class="p">)</span>
<span class="n">combined_df</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">normalize_features</span><span class="p">(</span>
    <span class="n">combined_df</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">combined_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#fix seed for reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">clustering</span> <span class="o">=</span> <span class="n">LeidenClustering</span><span class="p">(</span>
    <span class="n">leiden_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;n_iterations&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;resolution_parameter&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
    <span class="n">pca_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;n_components&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">},</span>
<span class="p">)</span>
<span class="n">clustering</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0, 5, 0, ..., 3, 3, 4])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># UMAP</span>
<span class="n">umap</span> <span class="o">=</span> <span class="n">UMAP</span><span class="o">.</span><span class="n">UMAP</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;euclidean&quot;</span><span class="p">)</span>
<span class="n">result_umap_euc</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="umap-plot-of-the-leiden-clustering">
<h3>UMAP plot of the Leiden clustering<a class="headerlink" href="#umap-plot-of-the-leiden-clustering" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter_3d</span><span class="p">(</span>
    <span class="n">result_umap_euc</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">z</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span>
    <span class="n">category_orders</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span><span class="p">)))]},</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;UMAP, clustering by leiden algorithm&quot;</span><span class="p">,</span>
    <span class="c1"># reduce size points</span>
    <span class="n">size_max</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">({</span><span class="s2">&quot;plot_bgcolor&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(0, 0, 0, 0)&quot;</span><span class="p">,</span> <span class="s2">&quot;paper_bgcolor&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(0, 0, 0, 0)&quot;</span><span class="p">})</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">font_color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">legend_title_text</span><span class="o">=</span><span class="s2">&quot;Cluster&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">,</span> <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">,</span> <span class="n">zaxis_title</span><span class="o">=</span><span class="s2">&quot;UMAP 3&quot;</span><span class="p">))</span>

<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
</section>
<section id="features-distributions-across-clusters">
<h3>Features distributions across clusters<a class="headerlink" href="#features-distributions-across-clusters" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot histogram features colored by cluster</span>
<span class="n">plot_data</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span>
<span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
<span class="n">n_features</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">n_cols</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">n_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_features</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_data</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="s2">&quot;cluster&quot;</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">plot_data</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
        <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="n">stat</span><span class="o">=</span><span class="s2">&quot;density&quot;</span><span class="p">,</span>
        <span class="n">common_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Histograms of normalized features colored by cluster&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9d9e601d21ce7753c2aba0c817f473e5b75e6e1809fa9ffebf9981eb66198dad.png" src="_images/9d9e601d21ce7753c2aba0c817f473e5b75e6e1809fa9ffebf9981eb66198dad.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the boxplots of features colored by cluster</span>
<span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;finished_normalized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;finished&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;finished&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="p">)</span> <span class="o">/</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;finished&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">plot_data</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">FEATURES_COLS_USED_FOR_CLUSTERING</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;finished_normalized&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clustering</span><span class="o">.</span><span class="n">labels_</span>
<span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
<span class="n">n_features</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">n_cols</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">n_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_features</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Boxplots of normalized features colored by cluster&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_data</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="s2">&quot;cluster&quot;</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">plot_data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;cluster&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e9f5bf3586814da42fa72459b661b7a7b9243f7409c7e215826a8f585f6fd616.png" src="_images/e9f5bf3586814da42fa72459b661b7a7b9243f7409c7e215826a8f585f6fd616.png" />
</div>
</div>
</section>
<section id="heatmap-of-feature-means-for-each-cluster">
<h3>Heatmap of feature means for each cluster<a class="headerlink" href="#heatmap-of-feature-means-for-each-cluster" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># heatmap of features means per cluster</span>
<span class="n">means</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.1f&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Heatmap of normalized features means per cluster&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ea0668e933f3225001ca9cc4c9248f3f1cf55b220d2f0f21f4922a1117c9a4c2.png" src="_images/ea0668e933f3225001ca9cc4c9248f3f1cf55b220d2f0f21f4922a1117c9a4c2.png" />
</div>
</div>
</section>
<section id="number-of-paths-per-cluster">
<h3>Number of paths per cluster<a class="headerlink" href="#number-of-paths-per-cluster" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clusters_names</span><span class="p">,</span><span class="n">n_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">clusters_names</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">n_points</span><span class="p">)</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Number of paths per cluster&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b9375a6f16039b846133fff75b1acd6c1ea6bce6cd479329c7d1b24c6b5e90e6.png" src="_images/b9375a6f16039b846133fff75b1acd6c1ea6bce6cd479329c7d1b24c6b5e90e6.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">FILTER_TIMEOUT</span><span class="p">:</span>
    <span class="c1"># number of timeouts per cluster</span>
    <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;timeout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;timeout&quot;</span>
    <span class="n">timeout_per_cluster</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;cluster&quot;</span><span class="p">])[</span><span class="s2">&quot;timeout&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">clusters_names</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">timeout_per_cluster</span><span class="p">)</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
        <span class="s2">&quot;Number of timeouts per cluster&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c2a45d66018260cfab0a37debd57666efb1d04fe5ae95d21cd3f6e1507140341.png" src="_images/c2a45d66018260cfab0a37debd57666efb1d04fe5ae95d21cd3f6e1507140341.png" />
</div>
</div>
<p>We can see that the paths corresponding to the timeouts are almost all assigned to the same cluster.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#description-of-the-features-used">Description of the features used</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-loading-and-pre-processing">Data loading and pre-processing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#correlations-and-pca">Correlations and PCA</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pca">PCA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#correlation-matrix">Correlation matrix</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clustering-without-the-timeouts">Clustering without the timeouts</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-clustering">The clustering</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-heatmap-of-feature-means-for-each-cluster">The Heatmap of feature means for each cluster…</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#and-the-number-of-paths-per-cluster">And the number of paths per cluster</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assessing-variability-using-clustroids">Assessing variability using clustroids</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assessing-the-variability-of-the-clustering-across-folds">Assessing the variability of the clustering across folds</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#matching-to-the-rescue">Matching to the rescue</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-of-clustroids-variation-across-folds">Plot of clustroids variation across folds</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#variability-of-features-across-folds-in-matched-clusters">Variability of features across folds in matched clusters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clustering-with-the-timeouts">Clustering with the timeouts</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#umap-plot-of-the-leiden-clustering">UMAP plot of the Leiden clustering</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#features-distributions-across-clusters">Features distributions across clusters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#heatmap-of-feature-means-for-each-cluster">Heatmap of feature means for each cluster</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#number-of-paths-per-cluster">Number of paths per cluster</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Cyril, David, Laurent, Mathilde, Yves
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>